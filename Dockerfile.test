FROM python:3.11-slim
ENV PYTHONUNBUFFERED=1

ARG DJANGO_SECRET=
ARG DJANGO_DEBUG=
ARG OPENAI_API_KEY=
ARG GOOGLE_VISION_API_KEY=
ARG POSTGRES_PASSWORD=
ARG ARANGODB_PASSWORD=
ARG CTIBUTLER_API_KEY=
ARG VULMATCH_API_KEY=
ARG MARKER_API_KEY=

ENV DJANGO_SECRET=${DJANGO_SECRET}
ENV DJANGO_DEBUG=${DJANGO_DEBUG}
ENV OPENAI_API_KEY=${OPENAI_API_KEY}
ENV GOOGLE_VISION_API_KEY=${GOOGLE_VISION_API_KEY}
ENV POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
ENV ARANGODB_PASSWORD=${ARANGODB_PASSWORD}
ENV CTIBUTLER_API_KEY=${CTIBUTLER_API_KEY}
ENV VULMATCH_API_KEY=${VULMATCH_API_KEY}
ENV MARKER_API_KEY=${MARKER_API_KEY}

ENV CELERY_BROKER_CONNECTION_RETRY_ON_STARTUP=1
ENV CELERY_BROKER_URL=redis://host.docker.internal:6379/3
ENV MAX_PAGE_SIZE=50
ENV DEFAULT_PAGE_SIZE=50
ENV TEMPERATURE=0.0
ENV INPUT_TOKEN_LIMIT=12500
ENV USE_S3_STORAGE=0
ENV CTIBUTLER_BASE_URL=https://api.ctibutler.com
ENV VULMATCH_BASE_URL=http://api.vulmatch.com
ENV HISTORY4FEED_URL=http://host.docker.internal:8002/
ENV ARANGODB_USERNAME=siemrules
ENV ARANGODB_HOST_URL=http://host.docker.internal:8529
ENV POSTGRES_USER=siemrules
ENV POSTGRES_DB=siemrules_database
ENV POSTGRES_HOST=host.docker.internal
ENV SRO_OBJECTS_ONLY_LATEST=False

WORKDIR /usr/src/app
COPY requirements.txt ./
RUN --mount=type=cache,target=/root/.cache \
    pip install -r requirements.txt

COPY . /usr/src/app